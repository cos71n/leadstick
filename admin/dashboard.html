<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeadStick Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1f2937;
            line-height: 1.6;
        }

        .auth-check {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f8fafc;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .auth-check .loading {
            text-align: center;
            color: #6b7280;
        }

        .header {
            background: white;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-bottom: 1px solid #e5e7eb;
            position: relative;
        }

        .header h1 {
            color: #1f2937;
            font-size: 24px;
            font-weight: 600;
        }

        .header p {
            color: #6b7280;
            margin-top: 4px;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #dc2626;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .logout-btn:hover {
            background: #b91c1c;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            gap: 20px;
        }

        .search-box {
            flex: 1;
            max-width: 400px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: border-color 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
        }

        .clients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .client-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }

        .client-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .client-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .client-info h3 {
            color: #1f2937;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .client-info .site-id {
            color: #6b7280;
            font-size: 14px;
            font-family: monospace;
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .theme-preview {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            flex-shrink: 0;
        }

        .client-details {
            margin-bottom: 16px;
        }

        .client-detail {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .client-detail .icon {
            width: 16px;
            text-align: center;
        }

        .questions-count {
            background: #f0f9ff;
            color: #0369a1;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .client-actions {
            display: flex;
            gap: 8px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #f3f4f6;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #fca5a5;
        }

        .success {
            background: #d1fae5;
            color: #065f46;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #6ee7b7;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #6b7280;
        }

        .empty-state h3 {
            color: #374151;
            margin-bottom: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 900px;
            width: 95%;
            max-height: 95vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h2 {
            color: #1f2937;
            font-size: 20px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            padding: 4px;
        }

        .modal-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 24px;
        }

        .modal-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .modal-tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .validation-error {
            color: #dc2626;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .form-group.error input,
        .form-group.error textarea,
        .form-group.error select {
            border-color: #dc2626;
            background: #fef2f2;
        }

        .form-group.error input:focus,
        .form-group.error textarea:focus,
        .form-group.error select:focus {
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .search-box.error input {
            border-color: #dc2626;
            background: #fef2f2;
        }

        .form-group .help-text {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        .color-input {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .color-input input[type="color"] {
            width: 50px;
            height: 40px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .color-input input[type="text"] {
            flex: 1;
        }

        .questions-builder {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #f8fafc;
            padding: 20px;
        }

        .questions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .questions-header h3 {
            color: #1f2937;
            font-size: 16px;
            font-weight: 600;
        }

        .add-question-dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background: white;
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            z-index: 1;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-item {
            display: block;
            padding: 12px 16px;
            text-decoration: none;
            color: #374151;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
        }

        .dropdown-item:hover {
            background: #f3f4f6;
        }

        .question-list {
            min-height: 100px;
        }

        .question-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: move;
            transition: all 0.2s;
        }

        .question-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .question-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .question-info h4 {
            color: #1f2937;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .question-type {
            color: #6b7280;
            font-size: 12px;
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .question-actions {
            display: flex;
            gap: 8px;
        }

        .question-actions button {
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: #f3f4f6;
            color: #6b7280;
        }

        .question-actions button:hover {
            background: #e5e7eb;
        }

        .question-preview {
            color: #6b7280;
            font-size: 13px;
            line-height: 1.4;
        }

        .options-list {
            margin-top: 8px;
            padding-left: 16px;
        }

        .options-list li {
            color: #9ca3af;
            font-size: 12px;
        }

        .question-editor-modal .modal-content {
            max-width: 600px;
        }

        .option-builder {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            margin-top: 8px;
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .option-item input {
            flex: 1;
            margin: 0;
        }

        .option-item button {
            padding: 4px 8px;
            background: #fee2e2;
            color: #dc2626;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #f3f4f6;
        }

        .drag-handle {
            color: #9ca3af;
            cursor: move;
            margin-right: 8px;
        }

        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                max-width: none;
            }

            .clients-grid {
                grid-template-columns: 1fr;
            }

            .client-actions {
                flex-direction: column;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
                margin: 10px;
            }

            .modal-tabs {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Check Screen -->
    <div id="authCheck" class="auth-check">
        <div class="loading">
            <div>üîê Verifying access...</div>
        </div>
    </div>

    <!-- Main Dashboard (Hidden until authenticated) -->
    <div id="mainContent" style="display: none;">
        <div class="header">
            <h1>üöÄ LeadStick Dashboard</h1>
            <p>Manage your client widget configurations</p>
            <button onclick="logout()" class="logout-btn">
                Logout
            </button>
        </div>

        <div class="container">
            <div class="toolbar">
                <div class="search-box" id="searchBox">
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="Search clients..." 
                        maxlength="100"
                        oninput="validateSearchInput()"
                        onkeyup="filterClients()"
                    >
                    <div id="searchError" class="validation-error"></div>
                </div>
                <button class="btn btn-primary" onclick="openNewClientModal()">
                    ‚ûï Add New Client
                </button>
            </div>

            <div id="statusMessage"></div>
            
            <div id="loadingState" class="loading">
                <div>Loading clients...</div>
            </div>

            <div id="clientsContainer" class="clients-grid" style="display: none;">
                <!-- Clients will be loaded here -->
            </div>

            <div id="emptyState" class="empty-state" style="display: none;">
                <h3>No clients yet</h3>
                <p>Get started by adding your first client configuration</p>
                <button class="btn btn-primary" onclick="openNewClientModal()" style="margin-top: 20px;">
                    ‚ûï Add Your First Client
                </button>
            </div>
        </div>

        <!-- Client Modal and other modals go here -->
        <!-- (I'll add these if needed - keeping this shorter for now) -->
    </div>

    <script id="main-script">
        // CSP-safe script initialization
        (async function initializeApp() {
            try {
                // Fetch nonce from API for CSP compliance
                const nonceResponse = await fetch('https://leadstick-api.attribution.workers.dev/admin/nonce');
                const nonceData = await nonceResponse.json();
                
                // Set nonce for any dynamically created scripts
                window.CSP_NONCE = nonceData.nonce;
                
                // Initialize app constants
                window.API_BASE = 'https://leadstick-api.attribution.workers.dev';
                window.sessionToken = null;
                window.csrfToken = null;
                window.clients = [];
                window.editingClient = null;
                
                // Continue with app initialization
                initializeAppComponents();
            } catch (error) {
                console.error('Failed to initialize app:', error);
                // Fallback initialization without nonce
                window.API_BASE = 'https://leadstick-api.attribution.workers.dev';
                window.sessionToken = null;
                window.csrfToken = null;
                window.clients = [];
                window.editingClient = null;
                initializeAppComponents();
            }
        })();

        function initializeAppComponents() {
            // Use global variables for consistency
            const API_BASE = window.API_BASE;
            let sessionToken = window.sessionToken;
            let csrfToken = window.csrfToken;
            let clients = window.clients;
            let editingClient = window.editingClient;
            
            let currentQuestions = [];
            let editingQuestionIndex = -1;

            // Authentication check on page load
        document.addEventListener('DOMContentLoaded', async function() {
            const authCheckDiv = document.getElementById('authCheck');
            const mainContentDiv = document.getElementById('mainContent');
            
            try {
                // Get stored tokens
                sessionToken = sessionStorage.getItem('leadstick_admin_token');
                csrfToken = sessionStorage.getItem('leadstick_csrf_token');
                
                if (!sessionToken || !csrfToken) {
                    throw new Error('No authentication tokens found');
                }
                
                // Verify tokens with server by trying to load clients
                const response = await authenticatedFetch(`${API_BASE}/admin/clients`);
                
                if (!response.ok) {
                    throw new Error('Invalid or expired session');
                }
                
                // Authentication successful
                authCheckDiv.style.display = 'none';
                mainContentDiv.style.display = 'block';
                
                // Load dashboard data
                loadClients();
                setupColorInputSync();
                setupDragAndDrop();
                
            } catch (error) {
                console.warn('Authentication failed:', error.message);
                // Redirect to login page
                window.location.href = './login.html';
            }
        });

        // Create authenticated fetch function
        function authenticatedFetch(url, options = {}) {
            if (!sessionToken) {
                throw new Error('Not authenticated');
            }
            
            const authHeaders = {
                'Authorization': `Bearer ${sessionToken}`,
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            // Add CSRF token for state-changing operations
            if (options.method && ['POST', 'PUT', 'DELETE'].includes(options.method.toUpperCase()) && csrfToken) {
                authHeaders['X-CSRF-Token'] = csrfToken;
            }
            
            return fetch(url, {
                ...options,
                headers: authHeaders
            });
        }

        // Load all clients
        async function loadClients() {
            try {
                showLoading(true);
                const response = await authenticatedFetch(`${API_BASE}/admin/clients`);
                const data = await response.json();

                if (!response.ok) {
                    if (response.status === 401) {
                        // Session expired, redirect to login
                        window.location.href = './login.html';
                        return;
                    }
                    throw new Error(data.error || 'Failed to load clients');
                }

                clients = data.clients || [];
                renderClients();
            } catch (error) {
                showError('Failed to load clients: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Render clients grid
        function renderClients() {
            const container = document.getElementById('clientsContainer');
            const emptyState = document.getElementById('emptyState');

            if (clients.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'grid';
            emptyState.style.display = 'none';

            // Clear container safely
            container.textContent = '';
            
            // Create client cards using safe DOM manipulation
            clients.forEach(client => {
                const clientCard = document.createElement('div');
                clientCard.className = 'client-card';
                clientCard.setAttribute('data-site-id', client.siteId);
                
                // Client header
                const header = document.createElement('div');
                header.className = 'client-header';
                
                const clientInfo = document.createElement('div');
                clientInfo.className = 'client-info';
                
                const title = document.createElement('h3');
                title.textContent = client.businessName;
                clientInfo.appendChild(title);
                
                const siteIdDiv = document.createElement('div');
                siteIdDiv.className = 'site-id';
                siteIdDiv.textContent = client.siteId;
                clientInfo.appendChild(siteIdDiv);
                
                const themePreview = document.createElement('div');
                themePreview.className = 'theme-preview';
                themePreview.style.backgroundColor = client.theme;
                
                header.appendChild(clientInfo);
                header.appendChild(themePreview);
                
                // Client details
                const details = document.createElement('div');
                details.className = 'client-details';
                
                // Agent detail
                const agentDetail = document.createElement('div');
                agentDetail.className = 'client-detail';
                const agentIcon = document.createElement('span');
                agentIcon.className = 'icon';
                agentIcon.textContent = 'üë§';
                const agentName = document.createElement('span');
                agentName.textContent = client.agentName;
                agentDetail.appendChild(agentIcon);
                agentDetail.appendChild(agentName);
                
                // Email detail
                const emailDetail = document.createElement('div');
                emailDetail.className = 'client-detail';
                const emailIcon = document.createElement('span');
                emailIcon.className = 'icon';
                emailIcon.textContent = '‚úâÔ∏è';
                const emailSpan = document.createElement('span');
                emailSpan.textContent = client.email;
                emailDetail.appendChild(emailIcon);
                emailDetail.appendChild(emailSpan);
                
                // Questions detail
                const questionsDetail = document.createElement('div');
                questionsDetail.className = 'client-detail';
                const questionsIcon = document.createElement('span');
                questionsIcon.className = 'icon';
                questionsIcon.textContent = '‚ùì';
                const questionsSpan = document.createElement('span');
                questionsSpan.className = 'questions-count';
                questionsSpan.textContent = 'Questions configured';
                questionsDetail.appendChild(questionsIcon);
                questionsDetail.appendChild(questionsSpan);
                
                details.appendChild(agentDetail);
                details.appendChild(emailDetail);
                details.appendChild(questionsDetail);
                
                // Client actions
                const actions = document.createElement('div');
                actions.className = 'client-actions';
                
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-secondary btn-small';
                editBtn.textContent = '‚úèÔ∏è Edit';
                editBtn.onclick = () => editClient(client.siteId);
                
                const previewBtn = document.createElement('button');
                previewBtn.className = 'btn btn-primary btn-small';
                previewBtn.textContent = 'üëÅÔ∏è Preview';
                previewBtn.onclick = () => previewClient(client.siteId);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-small';
                deleteBtn.textContent = 'üóëÔ∏è Delete';
                deleteBtn.onclick = () => deleteClient(client.siteId);
                
                actions.appendChild(editBtn);
                actions.appendChild(previewBtn);
                actions.appendChild(deleteBtn);
                
                // Assemble the card
                clientCard.appendChild(header);
                clientCard.appendChild(details);
                clientCard.appendChild(actions);
                
                container.appendChild(clientCard);
            });
        }

        // Input validation functions
        function validateSearchInput() {
            const searchInput = document.getElementById('searchInput');
            const searchBox = document.getElementById('searchBox');
            const searchError = document.getElementById('searchError');
            const searchTerm = searchInput.value;
            
            // Clear previous validation state
            searchBox.classList.remove('error');
            searchError.style.display = 'none';
            searchError.textContent = '';
            
            // Skip validation for empty input
            if (searchTerm.length === 0) {
                return true;
            }
            
            const errors = [];
            
            // Length validation
            if (searchTerm.length > 100) {
                errors.push('Search term is too long (max 100 characters)');
            }
            
            // Security validation - prevent XSS and injection attempts
            const dangerousChars = /<|>|'|"|;|--|\/\*|\*\/|script|javascript:|data:|vbscript:|onload|onerror/i;
            if (dangerousChars.test(searchTerm)) {
                errors.push('Search contains invalid characters');
            }
            
            // Prevent potential SQL injection patterns
            const sqlPatterns = /(\bselect\b|\binsert\b|\bupdate\b|\bdelete\b|\bdrop\b|\bunion\b|\bexec\b)/i;
            if (sqlPatterns.test(searchTerm)) {
                errors.push('Invalid search pattern');
            }
            
            if (errors.length > 0) {
                searchBox.classList.add('error');
                searchError.textContent = errors[0];
                searchError.style.display = 'block';
                return false;
            }
            
            return true;
        }
        
        function sanitizeInput(input) {
            if (typeof input !== 'string') return '';
            return input.trim().replace(/[<>'"&]/g, '');
        }
        
        function validateClientInput(inputId, value, type) {
            const errors = [];
            
            switch (type) {
                case 'siteId':
                    if (!value) errors.push('Site ID is required');
                    else if (value.length < 3) errors.push('Site ID must be at least 3 characters');
                    else if (value.length > 50) errors.push('Site ID must be less than 50 characters');
                    else if (!/^[a-zA-Z0-9-_]+$/.test(value)) errors.push('Site ID can only contain letters, numbers, hyphens, and underscores');
                    break;
                    
                case 'businessName':
                    if (!value) errors.push('Business name is required');
                    else if (value.length < 2) errors.push('Business name must be at least 2 characters');
                    else if (value.length > 100) errors.push('Business name must be less than 100 characters');
                    break;
                    
                case 'email':
                    if (!value) errors.push('Email is required');
                    else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) errors.push('Please enter a valid email address');
                    else if (value.length > 100) errors.push('Email must be less than 100 characters');
                    break;
                    
                case 'agentName':
                    if (value && value.length > 50) errors.push('Agent name must be less than 50 characters');
                    break;
                    
                case 'phone':
                    if (value && !/^[\d\s\-\+\(\)\.]+$/.test(value)) errors.push('Please enter a valid phone number');
                    else if (value && value.length > 20) errors.push('Phone number must be less than 20 characters');
                    break;
            }
            
            // Common security validation for all inputs
            const dangerousChars = /<|>|script|javascript:|data:|vbscript:|onload|onerror/i;
            if (dangerousChars.test(value)) {
                errors.push('Input contains invalid characters');
            }
            
            return errors;
        }
        
        function showInputError(inputId, message) {
            const input = document.getElementById(inputId);
            const group = input.closest('.form-group');
            let errorDiv = group.querySelector('.validation-error');
            
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'validation-error';
                group.appendChild(errorDiv);
            }
            
            group.classList.add('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        function clearInputError(inputId) {
            const input = document.getElementById(inputId);
            const group = input.closest('.form-group');
            const errorDiv = group.querySelector('.validation-error');
            
            group.classList.remove('error');
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }

        // Enhanced search functionality with validation
        function filterClients() {
            // Validate search input first
            if (!validateSearchInput()) {
                return;
            }
            
            const searchTerm = sanitizeInput(document.getElementById('searchInput').value.toLowerCase());
            const clientCards = document.querySelectorAll('.client-card');

            clientCards.forEach(card => {
                const siteId = card.dataset.siteId.toLowerCase();
                const businessName = card.querySelector('h3').textContent.toLowerCase();
                const email = card.querySelector('.client-detail:nth-child(2) span:last-child').textContent.toLowerCase();

                if (siteId.includes(searchTerm) || businessName.includes(searchTerm) || email.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function openNewClientModal() {
            alert('Client modal functionality will be implemented here');
        }

        function editClient(siteId) {
            alert(`Edit client: ${siteId}`);
        }

        function previewClient(siteId) {
            const previewUrl = `https://pub-2cf19529958742fea36d2ac68c558716.r2.dev/test-dynamic-config.html`;
            window.open(previewUrl, '_blank');
        }

        function deleteClient(siteId) {
            if (confirm(`Are you sure you want to delete "${siteId}"? This cannot be undone.`)) {
                alert(`Delete functionality for ${siteId} will be implemented here`);
            }
        }

        function logout() {
            sessionStorage.removeItem('leadstick_admin_token');
            sessionStorage.removeItem('leadstick_csrf_token');
            window.location.href = './login.html';
        }

        // Utility functions
        function showLoading(show) {
            document.getElementById('loadingState').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const container = document.getElementById('statusMessage');
            
            // Clear existing content safely
            container.textContent = '';
            
            // Create error element safely
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            
            container.appendChild(errorDiv);
            setTimeout(() => container.textContent = '', 5000);
        }

        function showSuccess(message) {
            const container = document.getElementById('statusMessage');
            
            // Clear existing content safely
            container.textContent = '';
            
            // Create success element safely
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            
            container.appendChild(successDiv);
            setTimeout(() => container.textContent = '', 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // Placeholder functions
        function setupColorInputSync() {
            // Will implement when adding full modal functionality
        }

        function setupDragAndDrop() {
            // Will implement when adding full modal functionality
        }
        
        } // End of initializeAppComponents function
    </script>
</body>
</html>